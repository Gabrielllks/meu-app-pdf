<input type="file" id="fileInput" accept="application/pdf" multiple style="font-size: 12px;">

<script>
    let pdfList = {}; // Armazena os objetos PDF por nome para visualizaÃ§Ã£o
    let miniSearch = new MiniSearch({
        fields: ['text'],
        storeFields: ['text', 'page', 'fileName'], // Guardamos o nome do arquivo tambÃ©m
        searchOptions: { fuzzy: 0.1, prefix: true }
    });

    document.getElementById('fileInput').onchange = async (e) => {
        const files = e.target.files;
        if (!files.length) return;

        document.getElementById('status').innerText = `Processando ${files.length} arquivo(s)...`;
        
        for (let file of files) {
            await processarArquivo(file);
        }
        
        document.getElementById('status').innerText = `${Object.keys(pdfList).length} arquivos indexados com sucesso!`;
    };

    async function processarArquivo(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                
                // Salva o PDF na lista global usando o nome do arquivo como chave
                pdfList[file.name] = pdf;

                let docs = [];
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    let rawText = textContent.items.map(s => s.str).join(' ');
                    
                    // DivisÃ£o por parÃ¡grafos
                    let paragraphs = rawText.split(/(?<=[.!?])\s+(?=[A-Z])/); 

                    paragraphs.forEach((p, idx) => {
                        if (p.trim().length > 40) {
                            docs.push({
                                id: `${file.name}-${i}-${idx}`, // ID Ãºnico incluindo nome do arquivo
                                text: p.trim(),
                                page: i,
                                fileName: file.name
                            });
                        }
                    });
                }
                miniSearch.addAll(docs);
                resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    // Ajuste na funÃ§Ã£o de busca para mostrar de qual arquivo veio o trecho
    function buscar() {
        const query = document.getElementById('searchInput').value;
        const results = miniSearch.search(query);
        const container = document.getElementById('results');
        container.innerHTML = "";

        if (results.length === 0) {
            container.innerHTML = "<p style='text-align:center'>Nenhum trecho encontrado.</p>";
            return;
        }

        results.slice(0, 15).forEach(res => {
            const div = document.createElement('div');
            div.className = 'source-card';
            // Agora passamos o nome do arquivo e a pÃ¡gina para o visualizador
            div.onclick = () => verNoPdf(res.fileName, res.page); 
            
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="page-badge">PÃ¡gina ${res.page}</span>
                    <span style="font-size: 10px; color: #70757a; font-weight: bold;">ðŸ“„ ${res.fileName}</span>
                </div>
                <div class="text-content">${highlight(res.text, query)}</div>
            `;
            container.appendChild(div);
        });
    }

    // Ajuste no visualizador para pegar o PDF correto da lista
    async function verNoPdf(fileName, pageNum) {
        const pdf = pdfList[fileName];
        if (!pdf) return;
        
        document.getElementById('pdfModal').style.display = 'flex';
        const page = await pdf.getPage(pageNum);
        const canvas = document.getElementById('pdfCanvas');
        const context = canvas.getContext('2d');
        
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        page.render({ canvasContext: context, viewport: viewport });
    }
</script>